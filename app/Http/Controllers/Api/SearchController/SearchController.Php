<?php

namespace App\Http\Controllers\Api\SearchController;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\News;
use App\Models\Subscriber;
use App\Models\Episode;
use App\Models\Podcast;
use App\Models\Season;
use App\Models\Release;

class SearchController extends Controller
{
    public function index(Request $request)
    {
        $query = $request->input('q');

        if (!$query) {
            return response()->json([
                'success' => false,
                'message' => 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«'
            ], 400);
        }

        $results = [];

        // ğŸ”¹ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
        if (class_exists(News::class)) {
            $results['news'] = News::where('title', 'LIKE', "%{$query}%")
                ->orWhere('content', 'LIKE', "%{$query}%")
                ->latest()
                ->get();
        }

        // ğŸ”¹ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
        if (class_exists(Subscriber::class)) {
            $results['subscribers'] = Subscriber::where('first_name', 'LIKE', "%{$query}%")
                ->orWhere('email', 'LIKE', "%{$query}%")
                ->get();
        }

        // ğŸ”¹ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³ØªØ§Øª
        if (class_exists(Podcast::class)) {
            $results['podcasts'] = Podcast::where('title', 'LIKE', "%{$query}%")
                ->orWhere('description', 'LIKE', "%{$query}%")
                ->latest()
                ->get();
        }

        // ğŸ”¹ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø³Ù…
        if (class_exists(Season::class)) {
            $results['seasons'] = Season::where('title', 'LIKE', "%{$query}%")
                ->orWhere('description', 'LIKE', "%{$query}%")
                ->latest()
                ->get();
        }

        // ğŸ”¹ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ù„Ù‚Ø§Øª
        if (class_exists(Episode::class)) {
            $results['episodes'] = Episode::where('title', 'LIKE', "%{$query}%")
                ->orWhere('description', 'LIKE', "%{$query}%")
                ->latest()
                ->get();
        }

        // ğŸ”¹ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª
        if (class_exists(Release::class)) {
            $results['releases'] = Release::where('title', 'LIKE', "%{$query}%")
                ->orWhere('description', 'LIKE', "%{$query}%")
                ->latest()
                ->get();
        }

        // ğŸ”¹ Ù„Ùˆ ÙƒÙ„Ù‡ ÙØ§Ø¶ÙŠ
        $isEmpty = collect($results)->every(fn($r) => count($r) === 0);

        return response()->json([
            'success' => true,
            'query' => $query,
            'empty' => $isEmpty,
            'results' => $results
        ]);
    }
}
